template: enphase-iq-battery
products:
  - brand: Enphase
    description:
      generic: IQ Battery
params:
  - name: usage
    choice: ["battery"]
  - name: host
  - name: token
    help:
      en: "Required if Envoy Firmware D7.x.xxx. Token is valid for one year. Instructions for obtaining a token via web UI: https://enphase.com/download/accessing-iq-gateway-local-apis-or-local-ui-token-based-authentication"
      de: "Ab Envoy Firmware D7.x.xxx notwendig. Token ist ein Jahr g√ºltig. Anleitung (Obtaining a token via web UI): https://enphase.com/download/accessing-iq-gateway-local-apis-or-local-ui-token-based-authentication"
  - name: capacity
    advanced: true
render: |
  type: custom
  {{- if eq .usage "battery" }}
  power:
    source: http
    uri: http://{{ .host }}/ivp/livedata/status
    {{- if .token }}
    auth:
      type: bearer
      password: {{ .token }}
    insecure: true
    {{- end }}
    jq: .meters.storage.agg_p_mw
    scale: 0.001
  soc:
    source: http
    uri: http://{{ .host }}/ivp/ensemble/inventory
    {{- if .token }}
    auth:
      type: bearer
      password: {{ .token }}
    insecure: true
    {{- end }}
    jq: .[].devices | map(.percentFull) | add / length
  setup:
    source: watchdog
    timeout: 5m
    set:
      source: http
      uri: http://{{ .host }}/ivp/livedata/stream
      method: POST
      headers:
      - content-type: application/json
      {{- if .token }}
      auth:
        type: bearer
        password: {{ .token }}
      insecure: true
      {{- end }}
      body: '{"enable":1}'
  {{- if .capacity }}
  capacity: {{ .capacity }} # kWh
  {{- end }}
  {{- end }}
